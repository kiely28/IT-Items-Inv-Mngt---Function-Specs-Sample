Below is a clear, practical, step-by-step guide showing exactly how to plug the OUT / Transfer transaction into your EXISTING IN module, without breaking your current structure or coding style.

This assumes:

You already have an IN Transaction module

You are using ASP.NET Core MVC (.NET 8)

EF Core with Stored Procedures only

Existing tables: tbl_students, tbl_category, tbl_location



---

‚úÖ STEP-BY-STEP: ADD OUT / TRANSFER INTO EXISTING IN MODULE


---

üîπ STEP 1: CONFIRM YOUR EXISTING IN MODULE STRUCTURE

Your IN module already has:

tbl_students (main stock table)

ControlNo generated during IN

Category ‚Üí UOM ‚Üí Quantity rules

Location assigned during IN


‚úî OUT will reuse the same ControlNo
‚úî NO ControlNo generation in OUT


---

üîπ STEP 2: ADD TRANSFER HISTORY TABLE (SAFE ‚Äì NO IMPACT TO IN)

CREATE TABLE tbl_transfer (
    TransferId INT IDENTITY PRIMARY KEY,
    StudentId INT NOT NULL,
    ControlNo NVARCHAR(50) NOT NULL,
    FromLocationId INT NOT NULL,
    ToLocationId INT NOT NULL,
    TransferDate DATETIME DEFAULT GETDATE(),
    TransactedBy NVARCHAR(100)
);

‚û° This does NOT affect existing IN logic


---

üîπ STEP 3: ADD STORED PROCEDURES (OUT ONLY)

3.1 Get Item by Control No

(Used by OUT page ‚Äì does NOT touch IN)

CREATE PROCEDURE sp_GetStudentByControlNo
    @ControlNo NVARCHAR(50)
AS
BEGIN
    SELECT 
        StudentId,
        ControlNo,
        Quantity,
        Uom,
        LocationId
    FROM tbl_students
    WHERE ControlNo = @ControlNo
      AND IsActive = 1;
END


---

3.2 Transfer OUT Procedure

(ALL logic here, IN module untouched)

CREATE PROCEDURE sp_TransferOut
    @ControlNo NVARCHAR(50),
    @NewLocationId INT,
    @TransactedBy NVARCHAR(100)
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @StudentId INT, @OldLocationId INT;

    SELECT 
        @StudentId = StudentId,
        @OldLocationId = LocationId
    FROM tbl_students
    WHERE ControlNo = @ControlNo
      AND IsActive = 1;

    IF @StudentId IS NULL
        RAISERROR('Control No not found.',16,1);

    IF @OldLocationId = @NewLocationId
        RAISERROR('New location must be different.',16,1);

    INSERT INTO tbl_transfer
    (
        StudentId,
        ControlNo,
        FromLocationId,
        ToLocationId,
        TransactedBy
    )
    VALUES
    (
        @StudentId,
        @ControlNo,
        @OldLocationId,
        @NewLocationId,
        @TransactedBy
    );

    UPDATE tbl_students
    SET LocationId = @NewLocationId
    WHERE StudentId = @StudentId;
END


---

üîπ STEP 4: ADD MODELS (DO NOT TOUCH IN MODELS)

4.1 Transfer POCO

public class Transfer
{
    public int TransferId { get; set; }
    public int StudentId { get; set; }
    public string ControlNo { get; set; }
    public int FromLocationId { get; set; }
    public int ToLocationId { get; set; }
    public DateTime TransferDate { get; set; }
}


---

4.2 Transfer ViewModel

public class TransferViewModel
{
    public string ControlNo { get; set; }
    public int NewLocationId { get; set; }
}

‚úî Separate ViewModel = no risk to IN


---

üîπ STEP 5: EXTEND ApplicationDbContext (SAFE ADDITION)

> ‚ö† Do NOT modify existing IN methods
Only ADD these methods



public async Task TransferOutAsync(
    string controlNo,
    int newLocationId,
    string transactedBy)
{
    await Database.ExecuteSqlRawAsync(
        "EXEC sp_TransferOut @ControlNo, @NewLocationId, @TransactedBy",
        new SqlParameter("@ControlNo", controlNo),
        new SqlParameter("@NewLocationId", newLocationId),
        new SqlParameter("@TransactedBy", transactedBy)
    );
}

‚úî IN module remains untouched


---

üîπ STEP 6: ADD NEW CONTROLLER (DO NOT MERGE WITH IN)

public class OutTransactionController : Controller
{
    private readonly ApplicationDbContext _context;

    public OutTransactionController(ApplicationDbContext context)
    {
        _context = context;
    }

    public IActionResult Create()
    {
        ViewBag.Locations = GetLocations();
        return View();
    }

    [HttpPost]
    public async Task<IActionResult> Create(TransferViewModel model)
    {
        if (!ModelState.IsValid)
        {
            ViewBag.Locations = GetLocations();
            return View(model);
        }

        try
        {
            await _context.TransferOutAsync(
                model.ControlNo,
                model.NewLocationId,
                User.Identity?.Name ?? "System"
            );

            TempData["Success"] = "Transfer successful.";
            ModelState.Clear();
        }
        catch (Exception ex)
        {
            ModelState.AddModelError("", ex.Message);
        }

        ViewBag.Locations = GetLocations();
        return View();
    }

    private List<SelectListItem> GetLocations()
    {
        return new List<SelectListItem>
        {
            new("Warehouse A","1"),
            new("Warehouse B","2")
        };
    }
}

‚úî Keeps IN and OUT fully isolated


---

üîπ STEP 7: ADD VIEW (NEW FOLDER ‚Äì NO OVERWRITE)

üìÅ Views/OutTransaction/Create.cshtml

(Use the same scanner-friendly UI style as IN)


---

üîπ STEP 8: ADD MENU / NAVIGATION

Add OUT beside IN:

<li class="nav-item">
    <a class="nav-link" asp-controller="OutTransaction" asp-action="Create">
        OUT / Transfer
    </a>
</li>


---

üîπ STEP 9: TESTING ORDER (IMPORTANT)

1Ô∏è‚É£ IN transaction ‚Üí create ControlNo
2Ô∏è‚É£ Verify record in tbl_students
3Ô∏è‚É£ Open OUT page
4Ô∏è‚É£ Scan ControlNo
5Ô∏è‚É£ Scan New Location
6Ô∏è‚É£ Confirm:

tbl_transfer has record

tbl_students.LocationId updated



---

üîπ STEP 10: WHY THIS DOES NOT BREAK YOUR IN MODULE

‚úî No table changes to IN logic
‚úî No SP changes to IN logic
‚úî Separate controller
‚úî Separate ViewModel
‚úî Shared table update is intentional


---

‚úÖ FINAL ARCHITECTURE

IN MODULE
 ‚îî‚îÄ sp_InTransaction
 ‚îî‚îÄ tbl_students (insert)

OUT MODULE
 ‚îú‚îÄ sp_TransferOut
 ‚îú‚îÄ tbl_transfer (history)
 ‚îî‚îÄ tbl_students (update location)


---

üöÄ NEXT OPTIONAL UPGRADES

Auto-load current location via AJAX

Quantity-based OUT (partial transfer)

Transfer History page

Barcode debounce handling

Role-based authorization (OUT only)


If you want, tell me how your IN module is currently named (controller / SP names), and I will align the OUT module 1-to-1 with it.
