Sub CompareAndCopyData()
    Dim ws As Worksheet
    Dim wsSrc As Worksheet
    Dim wbSrc As Workbook
    Dim FilePath As Variant
    Dim lastRow As Long, lastRowSrc As Long
    Dim i As Long
    Dim FindRng As Range
    Dim SourceValueS As String, SourceValueT As String
    Dim CommaPosS As Long, CommaPosT As Long
    Dim S_Before As String, S_After As String
    Dim T_Before As String, T_After As String
    Dim poDate As Date, checkDate As Date, targetWednesday As Date
    Dim dayNum As Integer, daysToNextWednesday As Integer
    
    Application.ScreenUpdating = False
    Application.EnableEvents = False
    
    ' Set your Trial_WSS1 sheet (change if different)
    Set ws = ThisWorkbook.Sheets("Sheet1")
    
    ' Open File Dialog
    FilePath = Application.GetOpenFilename("Excel Files (*.xls*), *.xls*")
    If FilePath = False Then Exit Sub
    
    ' Open the selected workbook
    Set wbSrc = Workbooks.Open(FilePath)
    Set wsSrc = wbSrc.Sheets(1)
    
    lastRow = ws.Cells(ws.Rows.Count, "AI").End(xlUp).Row
    lastRowSrc = wsSrc.Cells(wsSrc.Rows.Count, "E").End(xlUp).Row
    
    For i = 14 To lastRow ' Assuming row 1 is header
        If ws.Cells(i, "AI").Value <> "" Then
            ' Search for exact match in source Column E
            Set FindRng = wsSrc.Range("E2:E" & lastRowSrc).Find(What:=ws.Cells(i, "AI").Value, LookIn:=xlValues, LookAt:=xlWhole)
            
            If Not FindRng Is Nothing Then
                ' --- Copy values if matched ---
                Dim firstAddress As String
                Dim matchFound As Boolean
                matchFound = False

                ' ? Copy G?AJ (only if AJ is empty)
                If Trim(ws.Cells(i, "AJ").Value) = "" Then
                    ' Check if Column G has value
                    If Trim(wsSrc.Cells(FindRng.Row, "G").Value) <> "" Then
                        ws.Cells(i, "AJ").Value = wsSrc.Cells(FindRng.Row, "G").Value
                        matchFound = True
                    Else
                        ' If G is empty, look for another same E with non-empty G
                        firstAddress = FindRng.Address
                        Do
                            Set FindRng = wsSrc.Range("E2:E" & lastRowSrc).FindNext(FindRng)
                            If FindRng Is Nothing Then Exit Do
                            If FindRng.Address = firstAddress Then Exit Do
                            If Trim(wsSrc.Cells(FindRng.Row, "G").Value) <> "" Then
                                ws.Cells(i, "AJ").Value = wsSrc.Cells(FindRng.Row, "G").Value
                                matchFound = True
                                Exit Do
                            End If
                        Loop
                    End If
                End If
                
                ' Always update other columns
                ws.Cells(i, "AK").Value = wsSrc.Cells(FindRng.Row, "X").Value
                ws.Cells(i, "AQ").Value = wsSrc.Cells(FindRng.Row, "AC").Value
                
                ' --- S and T Column Logic ---
                SourceValueS = Trim(wsSrc.Cells(FindRng.Row, "S").Value)
                SourceValueT = Trim(wsSrc.Cells(FindRng.Row, "T").Value)
                
                CommaPosS = InStr(1, SourceValueS, ",")
                CommaPosT = InStr(1, SourceValueT, ",")
                
                If CommaPosS = 0 Then
                    ws.Cells(i, "AM").Value = SourceValueS & " " & SourceValueT
                    ws.Cells(i, "AN").Value = "DIRECT"
                Else
                    S_Before = Trim(Left(SourceValueS, CommaPosS - 1))
                    S_After = Trim(Mid(SourceValueS, CommaPosS + 1))
                    
                    If CommaPosT > 0 Then
                        T_Before = Trim(Left(SourceValueT, CommaPosT - 1))
                        T_After = Trim(Mid(SourceValueT, CommaPosT + 1))
                    Else
                        T_Before = SourceValueT
                        T_After = SourceValueT
                    End If
                    
                    ws.Cells(i, "AM").Value = S_Before & " " & T_Before
                    ws.Cells(i, "AN").Value = S_After & " " & T_After
                End If
                
                ' --- Date Check Logic (Auto Next Week's Wednesday) ---
                If IsDate(ws.Cells(i, "K").Value) And IsDate(ws.Cells(i, "AK").Value) Then
                    poDate = ws.Cells(i, "K").Value
                    checkDate = ws.Cells(i, "AK").Value
                    
                    dayNum = Weekday(poDate, vbSunday)
                    daysToNextWednesday = ((4 - dayNum) + 7) Mod 7 + 7
                    targetWednesday = poDate + daysToNextWednesday
                    
                    If checkDate >= targetWednesday Then
                        ws.Cells(i, "AX").Value = "O"
                    Else
                        ws.Cells(i, "AX").ClearContents
                    End If
                End If
''            Else
''                ws.Cells(i, "AM").Interior.Color = 0
            End If
        End If
    Next i
    
    'wbSrc.Close SaveChanges:=False
    Application.ScreenUpdating = True
    Application.EnableEvents = True
    
    MsgBox "Comparison and copy process completed.", vbInformation
End Sub
